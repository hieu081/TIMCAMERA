<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý Camera PARK HILL - Đồng bộ thời gian thực</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  </head>
  <body class="bg-gray-100 font-sans min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
      // ================= CẤU HÌNH FIREBASE =================
      const firebaseConfig = {
        apiKey: "AIzaSyDfYZkJFMR1mD5G59n0EUDdnPdLR5SNo-w",
        authDomain: "vscam-6a746.firebaseapp.com",
        databaseURL: "https://vscam-6a746-default-rtdb.firebaseio.com",
        projectId: "vscam-6a746",
        storageBucket: "vscam-6a746.firebasestorage.app",
        messagingSenderId: "449278366724",
        appId: "1:449278366724:web:bdf4fc3ead4fb7f2795151",
        measurementId: "G-4Z101P6S5G",
      };

      // Khởi tạo Firebase
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const database = firebase.database();

      // ================= ỨNG DỤNG CHÍNH =================
      const App = () => {
        const [data, setData] = React.useState([]);
        const [searchTerm, setSearchTerm] = React.useState("");
        const [filters, setFilters] = React.useState({
          location: "",
          zone: "",
          hygiene: "",
        });
        const [isLoading, setIsLoading] = React.useState(true);
        const [syncStatus, setSyncStatus] = React.useState("Chưa kết nối");
        const [lastSync, setLastSync] = React.useState("");

        // Khởi tạo IndexedDB
        const dbPromise = idb.openDB("CameraDB", 1, {
          upgrade(db) {
            db.createObjectStore("hygieneStatus", { keyPath: "id" });
            db.createObjectStore("notes", { keyPath: "id" });
          },
        });

        // ================= XỬ LÝ DỮ LIỆU =================
        React.useEffect(() => {
          const loadData = async () => {
            try {
              // 1. Tải dữ liệu CSV
              const response = await fetch("DS.csv");
              const csvData = await response.text();

              Papa.parse(csvData, {
                header: true,
                complete: async (results) => {
                  // 2. Tải dữ liệu từ Firebase
                  setSyncStatus("Đang đồng bộ...");
                  const [hygieneSnapshot, notesSnapshot] = await Promise.all([
                    database.ref("hygieneStatus").once("value"),
                    database.ref("notes").once("value"),
                  ]);

                  const remoteHygiene = hygieneSnapshot.val() || {};
                  const remoteNotes = notesSnapshot.val() || {};

                  // 3. Kết hợp dữ liệu
                  const processedData = results.data.map((row, index) => ({
                    id: index,
                    "Vị trí": row["Vị trí"] || "",
                    IP_Camera: row["IP_Camera"] || "",
                    "Vị trí camera trên đầu ghi":
                      row["Vị trí camera trên đầu ghi"] || "",
                    "Vị trí Camera": row["Vị trí Camera"] || "",
                    Hygiene: remoteHygiene[index] || "Chưa vệ sinh",
                    Note: remoteNotes[index] || "",
                  }));

                  // 4. Lưu vào IndexedDB
                  const db = await dbPromise;
                  const tx = db.transaction("hygieneStatus", "readwrite");
                  Object.entries(remoteHygiene).forEach(([id, status]) => {
                    tx.store.put({ id: parseInt(id), status });
                  });

                  setData(processedData);
                  setIsLoading(false);
                  setSyncStatus("Đã kết nối");
                  setLastSync(new Date().toLocaleTimeString());
                },
              });
            } catch (error) {
              console.error("Lỗi tải dữ liệu:", error);
              setIsLoading(false);
              setSyncStatus("Lỗi kết nối");
            }
          };

          loadData();

          // Lắng nghe thay đổi từ Firebase
          const hygieneRef = database.ref("hygieneStatus");
          const notesRef = database.ref("notes");

          hygieneRef.on("value", (snapshot) => {
            const remoteData = snapshot.val() || {};
            setData((prev) =>
              prev.map((row) => ({
                ...row,
                Hygiene: remoteData[row.id] || row.Hygiene,
              }))
            );
            setLastSync(new Date().toLocaleTimeString());
          });

          notesRef.on("value", (snapshot) => {
            const remoteData = snapshot.val() || {};
            setData((prev) =>
              prev.map((row) => ({
                ...row,
                Note: remoteData[row.id] || row.Note,
              }))
            );
          });

          return () => {
            hygieneRef.off();
            notesRef.off();
          };
        }, []);

        // ================= XỬ LÝ THAY ĐỔI =================
        const handleHygieneChange = async (id, value) => {
          try {
            // 1. Cập nhật UI ngay lập tức
            setData((prev) =>
              prev.map((row) =>
                row.id === id ? { ...row, Hygiene: value } : row
              )
            );

            // 2. Lưu vào IndexedDB
            const db = await dbPromise;
            await db.put("hygieneStatus", { id, status: value });

            // 3. Đồng bộ lên Firebase
            await database.ref(`hygieneStatus/${id}`).set(value);
            setLastSync(new Date().toLocaleTimeString());
          } catch (error) {
            console.error("Lỗi khi cập nhật trạng thái:", error);
          }
        };

        const handleNoteChange = async (id, value) => {
          try {
            setData((prev) =>
              prev.map((row) => (row.id === id ? { ...row, Note: value } : row))
            );

            const db = await dbPromise;
            await db.put("notes", { id, note: value });

            await database.ref(`notes/${id}`).set(value);
          } catch (error) {
            console.error("Lỗi khi cập nhật ghi chú:", error);
          }
        };

        // ================= LỌC DỮ LIỆU =================
        const filteredData = data.filter((row) => {
          const matchesSearch = searchTerm
            ? Object.values(row).some((val) =>
                String(val).toLowerCase().includes(searchTerm.toLowerCase())
              )
            : true;

          const matchesFilters =
            (!filters.location || row["Vị trí"] === filters.location) &&
            (!filters.zone || row["Vị trí Camera"].includes(filters.zone)) &&
            (!filters.hygiene || row.Hygiene === filters.hygiene);

          return matchesSearch && matchesFilters;
        });

        // Lấy danh sách options cho bộ lọc
        const locations = [...new Set(data.map((row) => row["Vị trí"]))];
        const zones = [
          ...new Set(
            data.map((row) => row["Vị trí Camera"].match(/P\d{1,2}/)?.[0] || "")
          ),
        ].filter(Boolean);
        const hygieneOptions = ["Chưa vệ sinh", "Đã vệ sinh"];

        // ================= GIAO DIỆN =================
        return (
          <div className="container mx-auto p-4 max-w-7xl">
            {/* Header */}
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
              <div>
                <h1 className="text-2xl font-bold text-blue-600">
                  QUẢN LÝ CAMERA PARK HILL
                </h1>
                <div className="text-sm text-gray-500 mt-1">
                  Trạng thái:{" "}
                  <span
                    className={
                      syncStatus === "Đã kết nối"
                        ? "text-green-500"
                        : "text-red-500"
                    }
                  >
                    {syncStatus} | Lần cuối đồng bộ: {lastSync}
                  </span>
                </div>
              </div>
              <div className="text-right">
                <div className="text-sm">
                  Tổng camera: <span className="font-bold">{data.length}</span>{" "}
                  | Đã vệ sinh:{" "}
                  <span className="text-green-500 font-bold">
                    {data.filter((d) => d.Hygiene === "Đã vệ sinh").length}
                  </span>
                </div>
              </div>
            </div>

            {/* Bộ lọc */}
            <div className="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6 p-4 bg-white rounded-lg shadow">
              <input
                type="text"
                placeholder="Tìm kiếm theo IP, vị trí..."
                className="p-2 border rounded focus:ring-2 focus:ring-blue-500"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
              />

              <select
                value={filters.location}
                onChange={(e) =>
                  setFilters({ ...filters, location: e.target.value })
                }
                className="p-2 border rounded"
              >
                <option value="">Tất cả vị trí</option>
                {locations.map((loc) => (
                  <option key={loc} value={loc}>
                    {loc}
                  </option>
                ))}
              </select>

              <select
                value={filters.zone}
                onChange={(e) =>
                  setFilters({ ...filters, zone: e.target.value })
                }
                className="p-2 border rounded"
              >
                <option value="">Tất cả khu vực</option>
                {zones.map((zone) => (
                  <option key={zone} value={zone}>
                    {zone}
                  </option>
                ))}
              </select>

              <select
                value={filters.hygiene}
                onChange={(e) =>
                  setFilters({ ...filters, hygiene: e.target.value })
                }
                className="p-2 border rounded"
              >
                <option value="">Tất cả trạng thái</option>
                {hygieneOptions.map((opt) => (
                  <option key={opt} value={opt}>
                    {opt}
                  </option>
                ))}
              </select>

              <button
                onClick={() => {
                  setSearchTerm("");
                  setFilters({ location: "", zone: "", hygiene: "" });
                }}
                className="p-2 bg-gray-200 rounded hover:bg-gray-300"
              >
                Xóa bộ lọc
              </button>
            </div>

            {/* Bảng dữ liệu */}
            {isLoading ? (
              <div className="text-center py-8">
                <div className="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
                <p className="mt-2">Đang tải dữ liệu...</p>
              </div>
            ) : (
              <>
                <div className="overflow-x-auto bg-white rounded-lg shadow">
                  <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-blue-600 text-white">
                      <tr>
                        <th className="px-4 py-3 text-left">Vị trí</th>
                        <th className="px-4 py-3 text-left">IP Camera</th>
                        <th className="px-4 py-3 text-left">Vị trí Camera</th>
                        <th className="px-4 py-3 text-left">Trạng thái</th>
                        <th className="px-4 py-3 text-left">Ghi chú</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                      {filteredData.length > 0 ? (
                        filteredData.map((row) => (
                          <tr
                            key={row.id}
                            className={
                              row.Hygiene === "Chưa vệ sinh"
                                ? "bg-yellow-50 hover:bg-yellow-100"
                                : "hover:bg-gray-50"
                            }
                          >
                            <td className="px-4 py-2">{row["Vị trí"]}</td>
                            <td className="px-4 py-2 font-mono">
                              {row["IP_Camera"]}
                            </td>
                            <td className="px-4 py-2">
                              {row["Vị trí Camera"]}
                            </td>
                            <td className="px-4 py-2">
                              <select
                                value={row.Hygiene}
                                onChange={(e) =>
                                  handleHygieneChange(row.id, e.target.value)
                                }
                                className={`p-1 border rounded ${
                                  row.Hygiene === "Đã vệ sinh"
                                    ? "bg-green-50"
                                    : "bg-yellow-50"
                                }`}
                              >
                                {hygieneOptions.map((opt) => (
                                  <option key={opt} value={opt}>
                                    {opt}
                                  </option>
                                ))}
                              </select>
                            </td>
                            <td className="px-4 py-2">
                              <input
                                type="text"
                                value={row.Note}
                                onChange={(e) =>
                                  handleNoteChange(row.id, e.target.value)
                                }
                                placeholder="Nhập ghi chú..."
                                className="w-full p-1 border rounded focus:ring-2 focus:ring-blue-300"
                              />
                            </td>
                          </tr>
                        ))
                      ) : (
                        <tr>
                          <td
                            colSpan="5"
                            className="px-4 py-8 text-center text-gray-500"
                          >
                            Không tìm thấy camera nào phù hợp
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>

                {/* Công cụ hàng loạt */}
                <div className="mt-4 flex flex-wrap gap-2">
                  <button
                    onClick={() => {
                      if (
                        confirm(
                          "Đánh dấu TẤT CẢ camera hiển thị là 'Đã vệ sinh'?"
                        )
                      ) {
                        filteredData.forEach((row) => {
                          if (row.Hygiene !== "Đã vệ sinh") {
                            handleHygieneChange(row.id, "Đã vệ sinh");
                          }
                        });
                      }
                    }}
                    className="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
                  >
                    Đánh dấu đã vệ sinh (tất cả hiển thị)
                  </button>

                  <button
                    onClick={() => {
                      const csvData = Papa.unparse(filteredData);
                      const blob = new Blob([csvData], {
                        type: "text/csv;charset=utf-8;",
                      });
                      const url = URL.createObjectURL(blob);
                      const a = document.createElement("a");
                      a.href = url;
                      a.download = `camera_report_${new Date()
                        .toISOString()
                        .slice(0, 10)}.csv`;
                      a.click();
                    }}
                    className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                  >
                    Xuất CSV (bản hiển thị)
                  </button>
                </div>
              </>
            )}
          </div>
        );
      };

      // Render ứng dụng
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
